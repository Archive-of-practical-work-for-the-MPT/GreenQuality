{% extends 'base.html' %}

{% block title %}CRUD - {{ model_display_name }}{% endblock %}

{% block content %}
<div class="container crud-container">
    <div class="crud-header">
        <h2 class="section-title">Управление: {{ model_display_name }}</h2>
        
        <div class="crud-actions">
            <button class="btn btn-primary" onclick="loadData()">
                <i class="fas fa-sync-alt"></i> Обновить
            </button>
            <button class="btn btn-success" onclick="showCreateForm()">
                <i class="fas fa-plus"></i> Добавить
            </button>
            <a href="{% url 'control_panel' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Назад
            </a>
        </div>
    </div>
    
    <div class="crud-content">
        <div class="table-container">
            <table class="data-table" id="dataTable">
                <thead id="tableHead">
                    <!-- Заголовки будут заполнены через JavaScript -->
                </thead>
                <tbody id="tableBody">
                    <!-- Данные будут заполнены через JavaScript -->
                </tbody>
            </table>
            
            <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <p>Загрузка данных...</p>
            </div>
            
            <div id="noDataMessage" class="no-data-message" style="display: none;">
                <p>Нет данных для отображения</p>
            </div>
            
            <!-- Pagination controls -->
            <div id="paginationControls" class="pagination-controls" style="display: none;">
                <button id="prevPage" class="btn btn-secondary pagination-btn" onclick="changePage(currentPage - 1)">
                    <i class="fas fa-chevron-left"></i> Назад
                </button>
                <span id="pageInfo" class="page-info"></span>
                <button id="nextPage" class="btn btn-secondary pagination-btn" onclick="changePage(currentPage + 1)">
                    Вперед <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для создания/редактирования -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Добавить запись</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="crudForm">
                    <div id="formFields" class="form-fields">
                        <!-- Поля формы будут заполнены через JavaScript -->
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Сохранить
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">
                            <i class="fas fa-times"></i> Отмена
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно для подтверждения удаления -->
    <div id="deleteModal" class="modal">
        <div class="modal-content delete-modal">
            <div class="modal-header">
                <h3>Подтверждение удаления</h3>
                <span class="close" onclick="closeDeleteModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить эту запись? Это действие нельзя отменить.</p>
                <div class="form-actions">
                    <button class="btn btn-danger" onclick="confirmDelete()">
                        <i class="fas fa-trash"></i> Удалить
                    </button>
                    <button class="btn btn-secondary" onclick="closeDeleteModal()">
                        <i class="fas fa-times"></i> Отмена
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Глобальные переменные
    const modelName = '{{ model_name }}';
    const apiUrl = `/api/${modelName}/`;
    let currentData = [];
    let editingId = null;
    let deleteId = null;
    let currentPage = 1;
    const itemsPerPage = 25;

    // Загрузка данных при открытии страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadData();
    });

    // Загрузка данных с API
    function loadData() {
        // Показываем индикатор загрузки
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('dataTable').style.display = 'none';
        document.getElementById('noDataMessage').style.display = 'none';
        document.getElementById('paginationControls').style.display = 'none';
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                currentData = data;
                currentPage = 1;
                renderTableWithPagination();
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';
                
                if (data.length === 0) {
                    document.getElementById('noDataMessage').style.display = 'block';
                } else if (data.length > itemsPerPage) {
                    document.getElementById('paginationControls').style.display = 'flex';
                }
            })
            .catch(error => {
                console.error('Ошибка загрузки данных:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                alert('Ошибка загрузки данных');
            });
    }

    // Отображение таблицы с пагинацией
    function renderTableWithPagination() {
        if (currentData.length === 0) {
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="100%" class="no-data-cell">Нет данных</td></tr>';
            document.getElementById('paginationControls').style.display = 'none';
            return;
        }

        // Calculate pagination values
        const totalPages = Math.ceil(currentData.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, currentData.length);
        const pageData = currentData.slice(startIndex, endIndex);

        // Update pagination controls
        updatePaginationControls(totalPages);

        // Получаем ключи из первой записи для заголовков
        const headers = Object.keys(currentData[0]);
        
        // Создаем заголовки таблицы
        const thead = document.getElementById('tableHead');
        let headerRow = '<tr>';
        headers.forEach(header => {
            headerRow += `<th>${formatHeader(header)}</th>`;
        });
        headerRow += '<th>Действия</th>';
        headerRow += '</tr>';
        thead.innerHTML = headerRow;

        // Создаем строки таблицы
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        pageData.forEach((item, index) => {
            let row = `<tr>`;
            headers.forEach(header => {
                row += `<td>${formatValue(item[header])}</td>`;
            });
            
            // Кнопки действий
            const itemId = item.id || item.id_role || item.id_account || item.id_airport || 
                          item.id_airplane || item.id_employee || item.id_crew || item.id_flight || 
                          item.id_passenger || item.id_class || item.id_user || item.id_payment || 
                          item.id_ticket;
            
            row += `<td class="action-cell">
                <button class="btn btn-icon btn-warning" onclick="editItem(${itemId})" title="Редактировать">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-icon btn-danger" onclick="showDeleteModal(${itemId})" title="Удалить">
                    <i class="fas fa-trash"></i>
                </button>
            </td>`;
            row += '</tr>';
            
            tbody.innerHTML += row;
        });
    }

    // Обновление элементов управления пагинацией
    function updatePaginationControls(totalPages) {
        if (totalPages <= 1) {
            document.getElementById('paginationControls').style.display = 'none';
            return;
        }

        document.getElementById('paginationControls').style.display = 'flex';
        
        // Update page info
        const startIndex = (currentPage - 1) * itemsPerPage + 1;
        const endIndex = Math.min(currentPage * itemsPerPage, currentData.length);
        document.getElementById('pageInfo').textContent = `${startIndex}-${endIndex} из ${currentData.length}`;
        
        // Update button states
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages;
    }

    // Смена страницы
    function changePage(page) {
        const totalPages = Math.ceil(currentData.length / itemsPerPage);
        
        if (page < 1 || page > totalPages) {
            return;
        }
        
        currentPage = page;
        renderTableWithPagination();
    }

    // Форматирование заголовков
    function formatHeader(header) {
        const headerMap = {
            'id': 'ID',
            'id_role': 'ID Роли',
            'role_name': 'Название роли',
            'id_account': 'ID Аккаунта',
            'email': 'Email',
            'password': 'Пароль',
            'role_id': 'ID Роли',
            'created_at': 'Создан',
            'id_airport': 'ID Аэропорта',
            'name': 'Название',
            'city': 'Город',
            'country': 'Страна',
            'id_airplane': 'ID Самолета',
            'model': 'Модель',
            'registration_number': 'Регистрационный номер',
            'capacity': 'Вместимость',
            'economy_capacity': 'Эконом вместимость',
            'business_capacity': 'Бизнес вместимость',
            'first_capacity': 'Первый класс вместимость',
            'rows': 'Ряды',
            'seats_row': 'Мест в ряду',
            'id_employee': 'ID Сотрудника',
            'first_name': 'Имя',
            'patronymic': 'Отчество',
            'last_name': 'Фамилия',
            'position': 'Должность',
            'account_id': 'ID Аккаунта',
            'id_crew': 'ID Экипажа',
            'id_flight': 'ID Рейса',
            'status': 'Статус',
            'departure_airport_id': 'Аэропорт вылета',
            'arrival_airport_id': 'Аэропорт прибытия',
            'departure_time': 'Время вылета',
            'arrival_time': 'Время прибытия',
            'actual_departure_time': 'Факт. время вылета',
            'actual_arrival_time': 'Факт. время прибытия',
            'id_passenger': 'ID Пассажира',
            'passport_number': 'Номер паспорта',
            'bithday': 'Дата рождения',
            'id_class': 'ID Класса',
            'class_name': 'Название класса',
            'id_user': 'ID Пользователя',
            'phone': 'Телефон',
            'birthday': 'Дата рождения',
            'id_payment': 'ID Платежа',
            'payment_date': 'Дата платежа',
            'total_cost': 'Сумма',
            'user_id': 'ID Пользователя',
            'payment_method': 'Метод оплаты',
            'id_ticket': 'ID Билета',
            'flight_id': 'ID Рейса',
            'class_id': 'ID Класса',
            'seat': 'Место',
            'price': 'Цена',
            'passenger_id': 'ID Пассажира',
            'payment_id': 'ID Платежа'
        };
        
        return headerMap[header] || header;
    }

    // Форматирование значений
    function formatValue(value) {
        if (value === null || value === undefined) {
            return '<span class="null-value">—</span>';
        }
        
        if (typeof value === 'object' && value !== null) {
            return JSON.stringify(value);
        }
        
        // Форматирование дат
        if (typeof value === 'string' && /\d{4}-\d{2}-\d{2}T/.test(value)) {
            const date = new Date(value);
            return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU');
        }
        
        return value;
    }

    // Показ формы создания
    function showCreateForm() {
        editingId = null;
        document.getElementById('modalTitle').textContent = 'Добавить запись';
        generateFormFields({});
        openModal();
    }

    // Редактирование записи
    function editItem(id) {
        editingId = id;
        document.getElementById('modalTitle').textContent = 'Редактировать запись';
        
        // Найти запись по ID
        const item = currentData.find(item => 
            item.id === id || 
            item.id_role === id || 
            item.id_account === id || 
            item.id_airport === id || 
            item.id_airplane === id || 
            item.id_employee === id || 
            item.id_crew === id || 
            item.id_flight === id || 
            item.id_passenger === id || 
            item.id_class === id || 
            item.id_user === id || 
            item.id_payment === id || 
            item.id_ticket === id
        );
        
        if (item) {
            generateFormFields(item);
            openModal();
        } else {
            alert('Запись не найдена');
        }
    }

    // Генерация полей формы
    function generateFormFields(data) {
        const formFields = document.getElementById('formFields');
        let fieldsHtml = '';
        
        // Получаем все возможные поля из первой записи
        if (currentData.length > 0) {
            const sampleItem = currentData[0];
            for (const key in sampleItem) {
                // Пропускаем ID поля при создании
                if ((editingId || key !== 'id') && 
                    key !== 'id_role' && key !== 'id_account' && 
                    key !== 'id_airport' && key !== 'id_airplane' && 
                    key !== 'id_employee' && key !== 'id_crew' && 
                    key !== 'id_flight' && key !== 'id_passenger' && 
                    key !== 'id_class' && key !== 'id_user' && 
                    key !== 'id_payment' && key !== 'id_ticket') {
                    
                    const value = data[key] || '';
                    const label = formatHeader(key);
                    
                    // Определяем тип поля
                    let inputType = 'text';
                    if (key.includes('date') || key.includes('time')) {
                        inputType = 'datetime-local';
                    } else if (key.includes('email')) {
                        inputType = 'email';
                    } else if (key.includes('password')) {
                        inputType = 'password';
                    }
                    
                    fieldsHtml += `
                        <div class="form-group">
                            <label>${label}:</label>
                            <input type="${inputType}" name="${key}" value="${value}" class="form-control">
                        </div>
                    `;
                }
            }
        }
        
        formFields.innerHTML = fieldsHtml;
    }

    // Открытие модального окна
    function openModal() {
        document.getElementById('modal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    // Закрытие модального окна
    function closeModal() {
        document.getElementById('modal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    // Показ модального окна удаления
    function showDeleteModal(id) {
        deleteId = id;
        document.getElementById('deleteModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    // Закрытие модального окна удаления
    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        deleteId = null;
    }

    // Подтверждение удаления
    function confirmDelete() {
        if (deleteId) {
            fetch(`${apiUrl}${deleteId}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Запись успешно удалена');
                    closeDeleteModal();
                    loadData();
                } else {
                    alert('Ошибка удаления записи');
                }
            })
            .catch(error => {
                console.error('Ошибка удаления:', error);
                alert('Ошибка удаления записи');
            });
        }
    }

    // Обработка отправки формы
    document.getElementById('crudForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {};
        for (const [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        const method = editingId ? 'PUT' : 'POST';
        const url = editingId ? `${apiUrl}${editingId}/` : apiUrl;
        
        // Для PUT запросов нам нужно отправить JSON
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        };
        
        // Для POST запросов Django REST Framework ожидает form data
        if (method === 'POST') {
            delete options.headers['Content-Type'];
            options.body = formData;
        }
        
        fetch(url, options)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Ошибка сохранения');
                }
            })
            .then(result => {
                alert(editingId ? 'Запись успешно обновлена' : 'Запись успешно создана');
                closeModal();
                loadData();
            })
            .catch(error => {
                console.error('Ошибка сохранения:', error);
                alert('Ошибка сохранения записи');
            });
    });

    // Получение CSRF токена
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Закрытие модального окна при клике вне его
    window.onclick = function(event) {
        const modal = document.getElementById('modal');
        const deleteModal = document.getElementById('deleteModal');
        
        if (event.target == modal) {
            closeModal();
        }
        
        if (event.target == deleteModal) {
            closeDeleteModal();
        }
    }
</script>

<style>
    .crud-container {
        padding: 20px 0;
    }
    
    .crud-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .crud-actions {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    /* Button Styles */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 20px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        min-width: 120px;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn-primary {
        background: linear-gradient(45deg, #3498db, #2980b9);
        color: white;
    }
    
    .btn-success {
        background: linear-gradient(45deg, #0bda51, #08a53d);
        color: white;
    }
    
    .btn-secondary {
        background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        color: white;
    }
    
    .btn-danger {
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        color: white;
    }
    
    .btn-warning {
        background: linear-gradient(45deg, #f39c12, #d35400);
        color: white;
    }
    
    .btn-icon {
        min-width: auto;
        padding: 10px;
        width: 40px;
        height: 40px;
    }
    
    .table-container {
        background: white;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0 0 20px 0;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
    
    .data-table thead {
        background: linear-gradient(45deg, #0bda51, #08a53d);
        color: white;
    }
    
    .data-table th,
    .data-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #e1e8ed;
    }
    
    .data-table th {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 14px;
    }
    
    .data-table tbody tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .data-table tbody tr:hover {
        background-color: #e8f5e9;
        transition: all 0.2s ease;
    }
    
    .action-cell {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 10px 5px;
    }
    
    .null-value {
        color: #95a5a6;
        font-style: italic;
    }
    
    .no-data-cell {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
        font-style: italic;
    }
    
    .loading-indicator {
        text-align: center;
        padding: 40px;
    }
    
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid #0bda51;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .no-data-message {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
    }
    
    /* Pagination Styles */
    .pagination-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding: 15px 0;
    }
    
    .page-info {
        font-weight: 600;
        color: #2c3e50;
        font-size: 16px;
    }
    
    .pagination-btn {
        min-width: 100px;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        border: none;
        width: 90%;
        max-width: 700px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        position: relative;
        animation: modalopen 0.3s ease;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
    }
    
    .delete-modal {
        max-width: 500px;
    }
    
    .modal-header {
        padding: 20px 30px;
        border-bottom: 1px solid #e1e8ed;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(45deg, #0bda51, #08a53d);
        color: white;
        border-radius: 20px 20px 0 0;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 22px;
    }
    
    .modal-body {
        padding: 30px;
        flex: 1;
        overflow-y: auto;
    }
    
    .close {
        color: white;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    
    .close:hover,
    .close:focus {
        background-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }
    
    .form-fields {
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 10px;
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
        box-sizing: border-box;
    }
    
    .form-control:focus {
        border-color: #0bda51;
        outline: none;
        box-shadow: 0 0 0 3px rgba(11, 218, 81, 0.2);
        background-color: #fff;
    }
    
    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        flex-wrap: wrap;
    }
    
    /* Стили для полосы прокрутки */
    .form-fields::-webkit-scrollbar {
        width: 8px;
    }
    
    .form-fields::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .form-fields::-webkit-scrollbar-thumb {
        background: #0bda51;
        border-radius: 10px;
    }
    
    .form-fields::-webkit-scrollbar-thumb:hover {
        background: #08a53d;
    }
    
    @keyframes modalopen {
        from {opacity: 0; transform: translateY(-50px);}
        to {opacity: 1; transform: translateY(0);}
    }
    
    @media (max-width: 768px) {
        .crud-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .crud-actions {
            justify-content: center;
        }
        
        .btn {
            width: 100%;
            justify-content: center;
        }
        
        .table-container {
            padding: 10px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px 10px;
            font-size: 14px;
        }
        
        .action-cell {
            gap: 5px;
        }
        
        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 6px;
            font-size: 12px;
        }
        
        .modal-content {
            width: 95%;
            margin: 10% auto;
            padding: 15px;
        }
        
        .modal-header {
            padding: 15px 20px;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .form-fields {
            max-height: 50vh;
        }
        
        .pagination-controls {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }
        
        .page-info {
            text-align: center;
        }
        
        .pagination-btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}